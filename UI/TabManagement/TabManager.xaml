<UserControl x:Class="ExplorerPro.UI.TabManagement.TabManager"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ExplorerPro.UI.TabManagement"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    
    <UserControl.Resources>
        <!-- Ultra-Modern Gradients and Brushes -->
        <LinearGradientBrush x:Key="TabActiveGradient" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#FFFFFF" Offset="0"/>
            <GradientStop Color="#F8F9FA" Offset="1"/>
        </LinearGradientBrush>
        
        <LinearGradientBrush x:Key="TabHoverGradient" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#F0F7FF" Offset="0"/>
            <GradientStop Color="#E3F2FD" Offset="1"/>
        </LinearGradientBrush>
        
        <LinearGradientBrush x:Key="TabInactiveGradient" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#FAFAFA" Offset="0"/>
            <GradientStop Color="#F0F0F0" Offset="1"/>
        </LinearGradientBrush>

        <!-- Enhanced Animation Storyboards -->
        <Storyboard x:Key="TabHoverStoryboard">
            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" 
                           To="1.08" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <QuadraticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <!-- DropShadowEffect animations removed to prevent dependency object errors -->
        </Storyboard>
        
        <Storyboard x:Key="TabHoverExitStoryboard">
            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)" 
                           To="1.0" Duration="0:0:0.2">
                <DoubleAnimation.EasingFunction>
                    <QuadraticEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <!-- DropShadowEffect animations removed to prevent dependency object errors -->
        </Storyboard>

        <!-- Modern Icon Resources -->
        <DrawingImage x:Key="FolderIcon">
            <DrawingImage.Drawing>
                <DrawingGroup ClipGeometry="M0,0 V16 H16 V0 H0 Z">
                    <GeometryDrawing Brush="#FFD700" Geometry="F1 M16,16z M0,0z M2,2L14,2 14,4 2,4z M1,5L15,5 15,14 1,14z"/>
                    <GeometryDrawing Brush="#FFA500" Geometry="F1 M16,16z M0,0z M2,2L14,2 14,3 2,3z"/>
                </DrawingGroup>
            </DrawingImage.Drawing>
        </DrawingImage>
    </UserControl.Resources>
    
    <Grid>
        <TabControl x:Name="TabControl"
                   TabStripPlacement="Top"
                   SelectionChanged="TabControl_SelectionChanged"
                   AllowDrop="True"
                   Background="White"
                   BorderThickness="0"
                   Style="{x:Null}"
                   Padding="0"
                   Margin="0">
            
            <!-- Ultra-Modern TabItem Style -->
            <TabControl.ItemContainerStyle>
                <Style TargetType="TabItem">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="TabItem">
                                <Border x:Name="TabBorder"
                                      Background="{StaticResource TabInactiveGradient}"
                                      BorderBrush="#D0D7DE"
                                      BorderThickness="1,1,1,0"
                                      CornerRadius="12,12,0,0"
                                      Margin="2,4,2,0"
                                      Padding="0"
                                      RenderTransformOrigin="0.5,0.5">
                                    <Border.Effect>
                                        <DropShadowEffect x:Name="TabShadow" 
                                                        Color="#FF000000" 
                                                        Direction="270" 
                                                        ShadowDepth="2" 
                                                        BlurRadius="6" 
                                                        Opacity="0.1"/>
                                    </Border.Effect>
                                    <Border.RenderTransform>
                                        <TransformGroup>
                                            <ScaleTransform/>
                                            <TranslateTransform/>
                                        </TransformGroup>
                                    </Border.RenderTransform>
                                    
                                    <!-- Tab content will be provided by ItemTemplate -->
                                    <ContentPresenter x:Name="ContentSite"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Center"
                                                    ContentSource="Header"
                                                    Margin="8,8,8,8"/>
                                </Border>
                                
                                <ControlTemplate.Triggers>
                                    <!-- Selected tab with enhanced styling -->
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="TabBorder" Property="Background" Value="{StaticResource TabActiveGradient}"/>
                                        <Setter TargetName="TabBorder" Property="BorderBrush" Value="#0969DA"/>
                                        <Setter TargetName="TabBorder" Property="BorderThickness" Value="1,3,1,0"/>
                                        <!-- Enhanced shadow effects applied to the border's effect -->
                                        <Setter Property="Panel.ZIndex" Value="100"/>
                                    </Trigger>
                                    
                                    <!-- Enhanced hover effect -->
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="TabBorder" Property="Background" Value="{StaticResource TabHoverGradient}"/>
                                        <Trigger.EnterActions>
                                            <BeginStoryboard Storyboard="{StaticResource TabHoverStoryboard}"/>
                                        </Trigger.EnterActions>
                                        <Trigger.ExitActions>
                                            <BeginStoryboard Storyboard="{StaticResource TabHoverExitStoryboard}"/>
                                        </Trigger.ExitActions>
                                    </Trigger>
                                    
                                    <!-- Always show close button when selected -->
                                    <Trigger Property="IsSelected" Value="True">
                                        <!-- Button visibility is now handled in the DataTemplate -->
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0"/>
                    <Setter Property="MinWidth" Value="140"/>
                    <Setter Property="MaxWidth" Value="280"/>
                    <Setter Property="Height" Value="38"/>
                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                    <Setter Property="RenderTransform">
                        <Setter.Value>
                            <TransformGroup>
                                <ScaleTransform/>
                                <TranslateTransform/>
                            </TransformGroup>
                        </Setter.Value>
                    </Setter>
                </Style>
            </TabControl.ItemContainerStyle>
            
                            <!-- Enhanced tab item template with modern design -->
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <Grid x:Name="TabContentGrid">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Enhanced folder icon -->
                        <Image Grid.Column="0" 
                               Width="16" Height="16" 
                               Margin="4,0,8,0"
                               VerticalAlignment="Center"
                               Source="{StaticResource FolderIcon}"/>
                        
                        <!-- Enhanced tab title with better typography and rich tooltip -->
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=Header}" 
                                   VerticalAlignment="Center"
                                   FontSize="13"
                                   FontWeight="Medium"
                                   Foreground="#24292F"
                                   TextTrimming="CharacterEllipsis"
                                   MaxWidth="160"
                                   MouseDown="TabItem_MouseDown">
                            <TextBlock.ToolTip>
                                <ToolTip MaxWidth="400">
                                    <StackPanel>
                                        <TextBlock Text="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=Header}" 
                                                   FontWeight="SemiBold" 
                                                   FontSize="13"
                                                   Margin="0,0,0,4"/>
                                        <TextBlock Text="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=Tag.Path}" 
                                                   FontSize="11" 
                                                   Foreground="#666"
                                                   TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=Tag.LastAccessed, StringFormat='Last accessed: {0:f}'}" 
                                                   FontSize="10" 
                                                   Foreground="#888"
                                                   Margin="0,4,0,0"/>
                                    </StackPanel>
                                </ToolTip>
                            </TextBlock.ToolTip>
                            <TextBlock.Effect>
                                <DropShadowEffect Color="White" BlurRadius="1" ShadowDepth="0.5" Opacity="0.8"/>
                            </TextBlock.Effect>
                        </TextBlock>
                        
                        <!-- Ultra-modern pin button (hover-to-show) -->
                        <Button Grid.Column="2" 
                                Content="📌" 
                                Margin="4,0,2,0"
                                VerticalAlignment="Center"
                                FontSize="11"
                                Width="20" Height="20"
                                BorderThickness="0"
                                Background="Transparent"
                                Foreground="#656D76"
                                Click="PinTabButton_Click"
                                ToolTip="Pin/Unpin tab"
                                Opacity="0"
                                x:Name="TabPinButton">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="PinButtonBorder"
                                          Background="Transparent"
                                          CornerRadius="10"
                                          Padding="3">
                                        <ContentPresenter HorizontalAlignment="Center" 
                                                        VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="PinButtonBorder" Property="Background" Value="#F6F8FA"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>

                        <!-- Ultra-modern close button (hover-to-show) -->
                        <Button Grid.Column="3" 
                                Content="✕" 
                                Margin="2,0,4,0"
                                VerticalAlignment="Center"
                                FontSize="12"
                                FontWeight="Bold"
                                Width="24" Height="24"
                                BorderThickness="0"
                                Background="Transparent"
                                Foreground="#656D76"
                                Click="CloseTabButton_Click"
                                ToolTip="Close tab (Middle-click also closes)"
                                Opacity="0"
                                x:Name="TabCloseButton">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="CloseButtonBorder"
                                          Background="Transparent"
                                          CornerRadius="12"
                                          Padding="4">
                                        <ContentPresenter HorizontalAlignment="Center" 
                                                        VerticalAlignment="Center"/>
                                        <Border.Effect>
                                            <DropShadowEffect x:Name="CloseButtonShadow" 
                                                            Color="#FF000000" 
                                                            BlurRadius="3" 
                                                            ShadowDepth="1" 
                                                            Opacity="0"/>
                                        </Border.Effect>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Trigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <ColorAnimation Storyboard.TargetName="CloseButtonBorder"
                                                                      Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                      To="#E53E3E" Duration="0:0:0.15"/>
                                                        <ColorAnimation Storyboard.TargetProperty="(TextBlock.Foreground).(SolidColorBrush.Color)"
                                                                      To="White" Duration="0:0:0.15"/>
                                                                                                <!-- Shadow animation removed to prevent dependency object errors -->
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.EnterActions>
                                            <Trigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <ColorAnimation Storyboard.TargetName="CloseButtonBorder"
                                                                      Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                      To="Transparent" Duration="0:0:0.15"/>
                                                        <ColorAnimation Storyboard.TargetProperty="(TextBlock.Foreground).(SolidColorBrush.Color)"
                                                                      To="#656D76" Duration="0:0:0.15"/>
                                                                                                <!-- Shadow animation removed to prevent dependency object errors -->
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </Trigger.ExitActions>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                        
                        <!-- Add triggers to the Grid to handle button visibility -->
                        <Grid.Triggers>
                            <EventTrigger RoutedEvent="Grid.MouseEnter">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="TabCloseButton"
                                                       Storyboard.TargetProperty="Opacity"
                                                       To="1" Duration="0:0:0.2"/>
                                        <DoubleAnimation Storyboard.TargetName="TabPinButton"
                                                       Storyboard.TargetProperty="Opacity"
                                                       To="0.7" Duration="0:0:0.2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                            <EventTrigger RoutedEvent="Grid.MouseLeave">
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="TabCloseButton"
                                                       Storyboard.TargetProperty="Opacity"
                                                       To="0" Duration="0:0:0.15"/>
                                        <DoubleAnimation Storyboard.TargetName="TabPinButton"
                                                       Storyboard.TargetProperty="Opacity"
                                                       To="0" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </Grid.Triggers>
                    </Grid>
                </DataTemplate>
            </TabControl.ItemTemplate>
            
            <!-- Ultra-modern TabControl template -->
            <TabControl.Template>
                <ControlTemplate TargetType="TabControl">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Enhanced tab header with glass effect -->
                        <Border Grid.Row="0" 
                              Background="#F6F8FA"
                              BorderBrush="#D0D7DE"
                              BorderThickness="0,0,0,1">
                            <Border.Effect>
                                <DropShadowEffect Color="#FF000000" Direction="270" ShadowDepth="1" BlurRadius="3" Opacity="0.08"/>
                            </Border.Effect>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Tab headers -->
                                <TabPanel x:Name="HeaderPanel" 
                                         Grid.Column="0" 
                                         IsItemsHost="True"
                                         Background="Transparent"
                                         Panel.ZIndex="1"
                                         KeyboardNavigation.TabIndex="1"
                                         Margin="8,0,0,0"/>
                                
                                <!-- Ultra-modern add tab button -->
                                <Button x:Name="AddButton" 
                                       Grid.Column="1"
                                       Content="＋"
                                       Width="32" 
                                       Height="32"
                                       Margin="8,6"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"
                                       FontSize="16"
                                       FontWeight="Normal"
                                       Click="AddButton_Click"
                                       ToolTip="Add new file tree tab"
                                       Style="{x:Null}">
                                    <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="ButtonBorder"
                                                  Background="#FFFFFF"
                                                  BorderBrush="#D0D7DE"
                                                  BorderThickness="1.5"
                                                  CornerRadius="8"
                                                  Padding="0">
                                                <Border.Effect>
                                                    <DropShadowEffect x:Name="ButtonShadow" 
                                                                    Color="#FF000000" 
                                                                    Direction="270" 
                                                                    ShadowDepth="2" 
                                                                    BlurRadius="4" 
                                                                    Opacity="0.1"/>
                                                </Border.Effect>
                                                <ContentPresenter HorizontalAlignment="Center" 
                                                                VerticalAlignment="Center"
                                                                TextElement.Foreground="#24292F"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Trigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                              Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                              To="#F6F8FA" Duration="0:0:0.15"/>
                                                                <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                              Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                                              To="#0969DA" Duration="0:0:0.15"/>
                                                                                                                <!-- Shadow animations removed to prevent dependency object errors -->
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.EnterActions>
                                                    <Trigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                              Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                                              To="#FFFFFF" Duration="0:0:0.15"/>
                                                                <ColorAnimation Storyboard.TargetName="ButtonBorder"
                                                                              Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                                              To="#D0D7DE" Duration="0:0:0.15"/>
                                                                                                                <!-- Shadow animations removed to prevent dependency object errors -->
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.ExitActions>
                                                </Trigger>
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter TargetName="ButtonBorder" Property="Background" Value="#F0F7FF"/>
                                                    <!-- Note: ButtonShadow effect cannot be targeted from here due to scope -->
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Button.Template>
                                </Button>
                            </Grid>
                        </Border>
                        
                        <!-- Enhanced content area -->
                        <Border Grid.Row="1" 
                               Background="{TemplateBinding Background}"
                               Padding="0"
                               Margin="0">
                            <ContentPresenter x:Name="PART_SelectedContentHost" 
                                            ContentSource="SelectedContent"
                                            Margin="0"/>
                        </Border>
                    </Grid>
                </ControlTemplate>
            </TabControl.Template>
            
            <!-- Ultra-modern context menu for enhanced functionality -->
            <TabControl.ContextMenu>
                <ContextMenu Background="White" 
                           BorderBrush="#E1E4E8" 
                           BorderThickness="1"
                           Padding="4"
                           HasDropShadow="True">
                    <ContextMenu.Effect>
                        <DropShadowEffect Color="#FF000000" Direction="270" ShadowDepth="4" BlurRadius="12" Opacity="0.15"/>
                    </ContextMenu.Effect>
                    <ContextMenu.Resources>
                        <Style TargetType="MenuItem">
                            <Setter Property="Padding" Value="8,6"/>
                            <Setter Property="FontSize" Value="13"/>
                            <Setter Property="FontWeight" Value="Medium"/>
                            <Setter Property="Foreground" Value="#24292F"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <Trigger Property="IsHighlighted" Value="True">
                                    <Setter Property="Background" Value="#F6F8FA"/>
                                    <Setter Property="Foreground" Value="#0969DA"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                        <Style TargetType="Separator">
                            <Setter Property="Background" Value="#E1E4E8"/>
                            <Setter Property="Height" Value="1"/>
                            <Setter Property="Margin" Value="8,4"/>
                        </Style>
                    </ContextMenu.Resources>
                    
                    <MenuItem Header="📁 New File Tree Tab" Click="NewTabMenuItem_Click" />
                    <MenuItem Header="📋 Duplicate Tab" Click="DuplicateTabMenuItem_Click" />
                    <MenuItem Header="📌 Pin/Unpin Tab" Click="PinTabButton_Click" />
                    <MenuItem Header="✕ Close Tab" Click="CloseTabMenuItem_Click" />
                    <Separator />
                    <MenuItem Header="🔄 Refresh Tab" Click="RefreshTab_Click" />
                    <MenuItem Header="🔄 Refresh All Tabs" Click="RefreshAllTabs_Click" />
                    <Separator />
                    <MenuItem Header="🪟 Detach Tab" Click="DetachTabMenuItem_Click" />
                </ContextMenu>
            </TabControl.ContextMenu>
        </TabControl>
    </Grid>
</UserControl>